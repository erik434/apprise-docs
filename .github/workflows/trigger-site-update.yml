name: Trigger Website deploy

on:
  push:
    branches: [master]
    tags: ["v*"]
  workflow_dispatch:

# This workflow only dispatches an event using an explicit token.
# It does not need any repo permissions of its own.
permissions: {}

jobs:
  dispatch:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Dispatch apprise-site
        env:
          TOKEN: ${{ secrets.APPRISE_SITE_DISPATCH_TOKEN }}
          REF: ${{ github.ref }}
          REF_NAME: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail

          # Determine whether this push was a branch or a tag
          ref_type="branch"
          if [[ "$REF" == refs/tags/* ]]; then
            ref_type="tag"
          fi

          # Only allow master branch triggers from apprise-docs
          if [[ "$ref_type" == "branch" && "$REF_NAME" != "master" ]]; then
            echo "Ignoring non-master branch push: $REF_NAME"
            exit 0
          fi

          # Only allow v* tags for prod
          if [[ "$ref_type" == "tag" && "$REF_NAME" != v* ]]; then
            echo "Ignoring non-v* tag: $REF_NAME"
            exit 0
          fi

          payload=$(
            printf '{"event_type":"apprise-docs-updated","client_payload":{"ref_type":"%s","docs_ref":"%s","docs_ref_name":"%s"}}' \
              "$ref_type" "$REF" "$REF_NAME"
          )

          curl -fSsS --retry 3 --retry-delay 2 -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}" \
            https://api.github.com/repos/caronc/apprise-site/dispatches \
            -d "$payload"
